<html>
<head>
	<title>---</title>
	<script src="resources/jquery.js"></script>
	<link rel="stylesheet" type="text/css" href="resources/common.css"/>
	<script>
		/*global $*/
		var
			username = '%%USERNAME%%',
			title = 'MineNode - Minecraft Server Frontend for "%s"',
			clientid = '%%CLIENTID%%';

	</script>
	<script src="resources/common.js"></script>
</head>
<body>
	<div id="authenticate"><div>plz enter your password: <input type="text"/></div></div>
	<div id="container_server_properties">
		<h1>Properties</h1>
		<div id="server_properties"></div>
	</div>
	<div id="container_server_status">
		<button id="server_switch_on">start</button>
		<button id="server_switch_off">stop</button>
		<h1>Status: <span id="server_status">---</span></h1>
	</div>

	<div id="container_server_players">
		<h1>Players: <span id="server_players"></span></h1>
	</div>

	<div id="container_server_webclients">
		<h1>Webclients: <span id="server_webclients"></span></h1>
	</div>


	<div id="container_server_stdout">
		<h1>Stdout</h1>
		<div ><pre id="server_stdout" class="logcontainer"></pre></div>
	</div>


	<div id="container_server_stderr">
	<h1>Stderr</h1>
	<div><pre id="server_stderr" class="logcontainer"></pre></div>
	</div>
	<div>
		<label for="server_stdin">input:</label>
		<input type="text" size="40" id="server_stdin" />
	</div>
	<script>

	var stdin = '',
		stderr = '',
		stdout = '';

	function get(request, cb) {
		request.clientid = clientid;
		$.get('/' + username, request, cb, 'json');
	}

	function work() {

		var setProperties, poll;


		setProperties = function (data) {
			var n, s = '<table>';
			for (n in data) {
				if (n && data.hasOwnProperty(n)) {
					s += '<tr><td>' + n + '<\/td><td>' + data[n] + '<\/td><\/tr>\n';
				}
			}
			s += '<\/table>';
			$('#server_properties').html(s);

			if (data['level-name']) {
				document.title = title.replace('%s', data['level-name']);
			}

		};

		setWebclients = function (data) {
			$('#server_webclients').html(data.map(function (c) {
					var s = '<span title="%s - %s">%s</span>';
					if (c.clientid === clientid) {
						s = '<em>' + s + '<\/em>';
					}

					return s.
						replace('%s', c.clientid).
						replace('%s', c.userAgent).
						replace('%s', c.name);
				}).join(', '));
		};

		poll = function () {
			get({type: 'update'}, function (data) {

				if (typeof data == 'string') {
					data = JSON.parse(data);
				}

				if (!data) {
					throw 'aaaaaaaaaargs';
				}

				if (data.stdout) {
					stdout += data.stdout;
					$('#server_stdout').text(stdout).scrollTop($('#server_stdout')[0].scrollHeight);
				}
				if (data.stderr) {
					stderr += data.stderr;
					$('#server_stderr').text(stderr).scrollTop($('#server_stderr')[0].scrollHeight);
				}

				if (data.status) {
					$('#container_server_status').addClass('enabled').removeClass('disabled');
					$('#server_status').text('running');
				} else {
					$('#container_server_status').removeClass('enabled').addClass('disabled');
					$('#server_status').text('stopped');
				}

				if (data.clients) {
					setWebclients(data.clients);
				}

				if (data.players) {
					$('#server_players').text(data.players.join(', '));
				}

				if (data.properties) {
					setProperties(data.properties);
				}

				setTimeout(poll, 2000);
			}, 'json');
		};


		poll();

		$('#server_switch_on').click(function () {
			get({type: 'start'});
		});

		$('#server_switch_off').click(function () {
			get({type: 'stop'});
		});
	};

	$('#server_stdin').keyup(function (e) {
		if (e.keyCode === 13) {
			get({type: 'stdin', message: this.value});
			this.value = '';
		}
	});

	</script>
</body>
</html>
